<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inscriptos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0"></script> <!-- Adapter for time scale -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.1.0"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937; /* Fallback background */
        }
        #main-container {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.4);
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .chart-container {
            position: relative;
            height: 300px; /* Altura optimizada para móviles */
            width: 100%;
        }
        @media (min-width: 768px) { /* md breakpoint de Tailwind */
            .chart-container {
                height: 350px;
            }
        }
        select, option {
            background: rgba(40, 43, 54, 0.9);
            color: white;
        }
        h1, h3, p {
             text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .color-picker {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            width: 32px; height: 32px; padding: 0;
            border: none; border-radius: 50%; cursor: pointer; border: 2px solid white;
        }
        .color-picker::-webkit-color-swatch { border: none; border-radius: 50%; }
        .color-picker::-moz-color-swatch { border: none; border-radius: 50%; }
        canvas { cursor: pointer; }
    </style>
</head>
<body class="text-white min-h-screen">
    <div id="main-container" class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col sm:flex-row items-center justify-center text-center mb-8 bg-black/30 backdrop-blur-md rounded-2xl shadow-lg p-4 border border-white/20">
            <img src="https://i.ibb.co/4nqvFQGM/logo.png" alt="Logo" class="h-12 w-auto mb-4 sm:mb-0 sm:mr-6">
            <h1 class="text-xl sm:text-2xl md:text-3xl font-extrabold">Tablero de control de inscriptos - Marzo 2026</h1>
        </header>

        <!-- KPI Principal -->
        <div class="mb-8 p-6 bg-black/20 backdrop-blur-md rounded-2xl shadow-lg max-w-sm mx-auto text-center border border-white/20">
            <h3 class="text-lg font-semibold text-white/80">Total de Inscriptos (Filtrados)</h3>
            <p id="total-inscriptos" class="text-5xl sm:text-6xl font-extrabold">0</p>
        </div>

        <!-- Filtros -->
        <div class="mb-8 p-6 bg-black/20 backdrop-blur-md rounded-2xl shadow-lg border border-white/20">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="flex flex-col">
                    <label for="filter-asesora" class="font-semibold mb-1 text-sm">Asesora</label>
                    <select id="filter-asesora" class="p-2 rounded-lg bg-white/20 text-white border-2 border-transparent focus:border-white focus:outline-none"></select>
                </div>
                <div class="flex flex-col">
                    <label for="filter-mes" class="font-semibold mb-1 text-sm">Mes</label>
                    <select id="filter-mes" class="p-2 rounded-lg bg-white/20 text-white border-2 border-transparent focus:border-white focus:outline-none"></select>
                </div>
                <div class="flex flex-col">
                    <label for="filter-carrera" class="font-semibold mb-1 text-sm">Carrera</label>
                    <select id="filter-carrera" class="p-2 rounded-lg bg-white/20 text-white border-2 border-transparent focus:border-white focus:outline-none"></select>
                </div>
                <div class="flex flex-col">
                    <label for="filter-modalidad" class="font-semibold mb-1 text-sm">Modalidad</label>
                    <select id="filter-modalidad" class="p-2 rounded-lg bg-white/20 text-white border-2 border-transparent focus:border-white focus:outline-none"></select>
                </div>
                <button id="reset-filters-btn" class="w-full px-4 py-2 bg-amber-500 text-white font-semibold rounded-lg shadow-md hover:bg-amber-600 transition-all">Limpiar Filtros</button>
            </div>
        </div>

        <!-- Gráficos -->
        <main id="dashboard-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
             <!-- Reordered Charts -->
            <div class="p-6 bg-black/20 backdrop-blur-md rounded-2xl shadow-lg border border-white/20">
                <h3 class="text-xl font-bold mb-4 text-center">Inscriptos por Asesora</h3>
                <div class="chart-container"><canvas id="asesora-chart"></canvas></div>
            </div>
            <div class="p-6 bg-black/20 backdrop-blur-md rounded-2xl shadow-lg border border-white/20">
                <h3 class="text-xl font-bold mb-4 text-center">Inscriptos por Carrera</h3>
                <div class="chart-container"><canvas id="carrera-chart"></canvas></div>
            </div>
            <div class="p-6 bg-black/20 backdrop-blur-md rounded-2xl shadow-lg lg:col-span-2 border border-white/20">
                <h3 class="text-xl font-bold mb-4 text-center">Inscriptos por Modalidad</h3>
                <div class="chart-container"><canvas id="modalidad-chart"></canvas></div>
            </div>
             <div class="p-6 bg-black/20 backdrop-blur-md rounded-2xl shadow-lg lg:col-span-2 border border-white/20">
                <h3 class="text-xl font-bold mb-4 text-center">Línea de Tiempo de Inscriptos (por Día)</h3>
                <div class="chart-container"><canvas id="timeline-chart"></canvas></div>
            </div>
        </main>
        
        <!-- Controles de Asesoras -->
        <div class="mt-8 p-6 bg-black/20 backdrop-blur-md rounded-2xl shadow-lg max-w-2xl mx-auto border border-white/20">
            <h3 class="text-xl font-semibold mb-4 text-center">Gestión de Asesoras</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                <input type="text" id="new-advisor-name" placeholder="Añadir nueva asesora" class="w-full px-4 py-2 rounded-lg bg-white/20 placeholder-white/60 text-white border-2 border-transparent focus:border-white focus:outline-none">
                <button id="add-advisor-btn" class="w-full px-6 py-2 bg-white text-blue-600 font-semibold rounded-lg shadow-md hover:bg-gray-200 transition-all">Agregar Asesora</button>
            </div>
            <h4 class="text-lg font-semibold mb-2 text-center border-t border-white/20 pt-4 mt-4">Colores de Asesoras</h4>
            <div id="asesora-colors-container" class="space-y-2"></div>
        </div>


        <div class="mt-8 text-center" id="action-buttons">
             <button id="refresh-data-btn" class="px-8 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-all">
                Actualizar Datos
            </button>
        </div>
        <div id="message-container" class="text-center mt-4"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURACIÓN ---
            const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSrL0KyBFoN6o6ZDK-zoG0pDT1ViTcluQ173F0cVA26x-d94CHEbeHSlK4Y-VBmgdWyrbtuFbFZxd_D/pub?gid=0&single=true&output=csv';
            const careerData = {
                'AE': { name: 'Administración de Empresas', color: '#8da248' }, 'RH': { name: 'Recursos Humanos', color: '#b388c2' },
                'MKT': { name: 'Marketing', color: '#fa5d0f' }, 'ASC': { name: 'Analista de Sistemas', color: '#00b1e1' },
                'DW': { name: 'Desarrollo Web', color: '#a8927d' }, 'HYS': { name: 'Higiene y Seguridad', color: '#f4c01e' },
                'GI': { name: 'Gestión Inmobiliaria', color: '#bb242a' }, 'CDEIA': { name: 'Ciencia de Datos e IA', color: '#2d4693' }
            };
            const asesoraData = {
                'Kiara': { color: '#b388c2' },
                'Belen': { color: '#f4c01e' }
            };
            const colorPalette = ['#38bdf8', '#fb923c', '#4ade80', '#c084fc', '#f87171', '#fbbf24', '#2dd4bf'];
            let colorIndex = 0;
            let fullData = [];
            let chartInstances = {};
            let currentFilters = { asesora: 'todos', mes: 'todos', carrera: 'todos', modalidad: 'todos' }; // Track current filters for toggle
            Chart.register(ChartDataLabels);

            const showMessage = (msg, isError = false) => {
                const container = document.getElementById('message-container');
                container.innerHTML = `<p class="${isError ? 'text-red-300 bg-red-900/50' : 'text-green-300 bg-green-900/50'} p-4 rounded-lg inline-block">${msg}</p>`;
            };

            const normalizeString = (str = '') => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

            const parseRow = (row) => {
                const headers = Object.keys(row).map(h => normalizeString(h));
                const advisorKey = Object.keys(row)[headers.indexOf('asesora')];
                const timestampKey = Object.keys(row)[headers.indexOf('marca temporal')];
                const careerKey = Object.keys(row)[headers.indexOf('carrera')];
                const modalityKey = Object.keys(row)[headers.indexOf('modalidad')];

                const monthMap = { 'enero': 1, 'febrero': 2, 'marzo': 3, 'abril': 4, 'mayo': 5, 'junio': 6, 'julio': 7, 'agosto': 8, 'septiembre': 9, 'octubre': 10, 'noviembre': 11, 'diciembre': 12 };
                const monthNameMap = { 1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril', 5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto', 9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre' };
                
                const timestamp = row[timestampKey] || '';
                const dateParts = timestamp.toLowerCase().split(' de ');
                let monthIndex = -1;
                let day = NaN;
                let dateObject = null;
                let monthName = 'Desconocido';

                if (dateParts.length === 2) {
                    day = parseInt(dateParts[0], 10);
                    monthIndex = monthMap[dateParts[1].trim()];
                    if (!isNaN(day) && monthIndex !== undefined) {
                        const year = new Date().getFullYear(); // Assume current year if not specified
                        dateObject = new Date(year, monthIndex - 1, day);
                        monthName = monthNameMap[monthIndex];
                    }
                }
                
                let modality = 'No especificada';
                const rawModality = (row[modalityKey] || '').slice(-1).toUpperCase();
                if (rawModality === 'P') modality = 'Presencial';
                if (rawModality === 'S') modality = 'Semipresencial';
                if (rawModality === 'D') modality = 'A Distancia';
                
                return {
                    asesora: row[advisorKey] || 'N/A',
                    mes: monthName,
                    carrera: row[careerKey] || 'N/A',
                    modalidad: modality,
                    fecha: dateObject // Store the date object
                };
            };
            
            const renderAdvisorColorPickers = () => {
                const container = document.getElementById('asesora-colors-container');
                container.innerHTML = '';
                Object.keys(asesoraData).sort().forEach(asesora => {
                    const pickerHtml = `<div class="flex justify-between items-center p-2 rounded-lg hover:bg-white/10"><label for="color-${asesora}" class="text-white/90 font-semibold">${asesora}</label><input type="color" id="color-${asesora}" value="${asesoraData[asesora].color}" data-asesora="${asesora}" class="color-picker"></div>`;
                    container.insertAdjacentHTML('beforeend', pickerHtml);
                });
                container.querySelectorAll('.color-picker').forEach(picker => {
                    picker.addEventListener('change', e => {
                        asesoraData[e.target.dataset.asesora].color = e.target.value;
                        applyFiltersAndRender();
                    });
                });
            };

            const populateFilters = (data) => {
                const filters = { asesora: new Set(), mes: new Set(), carrera: new Set(), modalidad: new Set() };
                data.forEach(row => {
                    if (row.asesora !== 'N/A') filters.asesora.add(row.asesora);
                    if (row.mes !== 'Desconocido') filters.mes.add(row.mes);
                    if (row.carrera !== 'N/A') filters.carrera.add(row.carrera);
                    if (row.modalidad !== 'No especificada') filters.modalidad.add(row.modalidad);
                });

                filters.asesora.forEach(asesora => {
                    if (!asesoraData[asesora]) {
                        asesoraData[asesora] = { color: colorPalette[colorIndex % colorPalette.length] };
                        colorIndex++;
                    }
                });

                for (const key in filters) {
                    const select = document.getElementById(`filter-${key}`);
                    const currentValue = currentFilters[key]; // Restore previous filter value if exists
                    select.innerHTML = '<option value="todos">Todos</option>';
                    [...filters[key]].sort().forEach(value => { select.innerHTML += `<option value="${value}">${value}</option>`; });
                    select.value = currentValue || 'todos';
                }
                renderAdvisorColorPickers();
            };

            const applyFiltersAndRender = () => {
                currentFilters = { // Update current filters state
                    asesora: document.getElementById('filter-asesora').value,
                    mes: document.getElementById('filter-mes').value,
                    carrera: document.getElementById('filter-carrera').value,
                    modalidad: document.getElementById('filter-modalidad').value,
                };
                const filteredData = fullData.filter(row => Object.keys(currentFilters).every(key => currentFilters[key] === 'todos' || row[key] === currentFilters[key]));
                renderDashboard(filteredData);
            };

            const renderDashboard = (data) => {
                document.getElementById('total-inscriptos').textContent = data.length;
                const asesoraCounts = data.reduce((acc, row) => { acc[row.asesora] = (acc[row.asesora] || 0) + 1; return acc; }, {});
                const carreraCounts = data.reduce((acc, row) => { acc[row.carrera] = (acc[row.carrera] || 0) + 1; return acc; }, {});
                const modalidadCounts = data.reduce((acc, row) => { acc[row.modalidad] = (acc[row.modalidad] || 0) + 1; return acc; }, {});
                
                // Timeline data preparation
                const timelineCounts = data.reduce((acc, row) => {
                    if (row.fecha) {
                        const dateString = row.fecha.toISOString().split('T')[0]; // YYYY-MM-DD
                        acc[dateString] = (acc[dateString] || 0) + 1;
                    }
                    return acc;
                }, {});
                const sortedDates = Object.keys(timelineCounts).sort((a, b) => new Date(a) - new Date(b)); // Sort dates chronologically
                const timelineLabels = sortedDates;
                const timelineData = sortedDates.map(date => timelineCounts[date]);


                updateChart('timeline-chart', 'line', timelineLabels, timelineData, ['#fbbf24']); // Timeline chart
                updateChart('asesora-chart', 'bar', Object.keys(asesoraCounts), Object.values(asesoraCounts), Object.keys(asesoraCounts).map(a => asesoraData[a]?.color || '#38bdf8'));
                updateChart('carrera-chart', 'bar', Object.keys(carreraCounts), Object.values(carreraCounts), Object.keys(carreraCounts).map(c => careerData[c]?.color || '#94a3b8'));
                updateChart('modalidad-chart', 'pie', Object.keys(modalidadCounts), Object.values(modalidadCounts), ['#fb923c', '#4ade80', '#c084fc']);
            };
            
            const handleChartClick = (evt, elements, chartId, labels) => {
                if (elements.length === 0) return;
                const clickedLabel = labels[elements[0].index];
                let filterKey = null;
                let filterSelectId = null;

                if (chartId === 'asesora-chart') { filterKey = 'asesora'; filterSelectId = 'filter-asesora'; }
                else if (chartId === 'carrera-chart') { filterKey = 'carrera'; filterSelectId = 'filter-carrera'; }
                else if (chartId === 'modalidad-chart') { filterKey = 'modalidad'; filterSelectId = 'filter-modalidad'; }
                 // No filtering interaction for timeline chart

                if (filterKey && filterSelectId) {
                    const select = document.getElementById(filterSelectId);
                    // Toggle logic
                    if (currentFilters[filterKey] === clickedLabel) {
                         select.value = 'todos'; // Deselect if clicked again
                    } else {
                         select.value = clickedLabel; // Select
                    }
                    applyFiltersAndRender();
                }
            };

            const updateChart = (chartId, type, labels, data, colors) => {
                const ctx = document.getElementById(chartId).getContext('2d');
                if (chartInstances[chartId]) chartInstances[chartId].destroy();
                
                const isTimeline = chartId === 'timeline-chart';

                const chartOptions = {
                    onClick: (evt, elements) => handleChartClick(evt, elements, chartId, labels),
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: type !== 'bar' && !isTimeline, labels: { color: '#fff', font: { size: 14 } } },
                        datalabels: {
                            color: 'white',
                            anchor: type === 'bar' ? 'center' : 'end',
                            align: type === 'bar' ? 'center' : 'end',
                            font: { weight: 'bold', size: 16 },
                            formatter: (value) => value > 0 ? value : '',
                            textShadow: { color: 'rgba(0,0,0,0.7)', blur: 4, offsetX: 2, offsetY: 2 },
                            display: !isTimeline // Hide datalabels for timeline
                        }
                    },
                    scales: (type === 'bar' || isTimeline) ? {
                        y: { ticks: { color: '#fff', beginAtZero: true }, grid: { color: '#ffffff20' } },
                        x: isTimeline ? { 
                            type: 'time', 
                            time: { unit: 'day' }, 
                            ticks: { color: '#fff' }, 
                            grid: { color: '#ffffff20' } 
                        } : { 
                            ticks: { color: '#fff' }, 
                            grid: { color: '#ffffff20' } 
                        }
                    } : {}
                };
                
                // Specific config for line chart
                 if (isTimeline) {
                     chartOptions.elements = { point: { radius: 3 } }; // Show points
                     chartOptions.plugins.datalabels.display = false; // Ensure datalabels off for line
                 }

                chartInstances[chartId] = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{ 
                            label: isTimeline ? 'Inscriptos por Día' : 'Inscriptos', 
                            data: isTimeline ? data.map((count, index) => ({ x: labels[index], y: count })) : data,
                            backgroundColor: isTimeline ? colors[0] : colors, // Line uses single color
                            borderColor: isTimeline ? colors[0] : '#ffffff50',
                            borderWidth: isTimeline ? 2 : 1,
                            tension: 0.1 // Slight curve for timeline
                        }]
                    },
                    options: chartOptions
                });
            };
            
            const initializeDashboard = (data) => {
                const validData = data.filter(row => !Object.values(row).some(value => value === '#N/A'));
                fullData = validData.map(parseRow);
                populateFilters(fullData);
                applyFiltersAndRender();
            };

            const fetchData = async () => {
                showMessage('Actualizando datos...');
                try {
                    const response = await fetch(`${googleSheetUrl}&t=${new Date().getTime()}`);
                    if (!response.ok) throw new Error('No se pudo conectar a la hoja de cálculo.');
                    const csvText = await response.text();
                    Papa.parse(csvText, {
                        header: true, skipEmptyLines: true, transformHeader: h => h.trim(), bom: true,
                        complete: res => {
                            if (res.errors.length) throw new Error('Error al leer el formato del CSV.');
                            initializeDashboard(res.data);
                            showMessage('Datos actualizados correctamente.');
                        },
                        error: () => { throw new Error('Error crítico al procesar el archivo CSV.'); }
                    });
                } catch (error) {
                    showMessage(error.message, true);
                     // Render with empty data if fetch fails initially
                    fullData = [];
                    populateFilters([]);
                    applyFiltersAndRender();
                }
            };
            
            const handleAddAdvisor = () => {
                const name = newAdvisorNameInput.value.trim();
                if (!name || asesoraData[name]) {
                    alert(name ? 'Esa asesora ya existe.' : 'Por favor, ingresa un nombre.');
                    return;
                }
                asesoraData[name] = { color: colorPalette[colorIndex % colorPalette.length] };
                colorIndex++;
                newAdvisorNameInput.value = '';
                renderAdvisorColorPickers();
                // No need to call applyFiltersAndRender here, just update the picker list
            };
            
            document.getElementById('reset-filters-btn').addEventListener('click', () => {
                ['asesora', 'mes', 'carrera', 'modalidad'].forEach(key => document.getElementById(`filter-${key}`).value = 'todos');
                applyFiltersAndRender();
            });
            ['filter-asesora', 'filter-mes', 'filter-carrera', 'filter-modalidad'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFiltersAndRender);
            });
            document.getElementById('refresh-data-btn').addEventListener('click', fetchData);
            document.getElementById('add-advisor-btn').addEventListener('click', handleAddAdvisor);
            
            fetchData();
        });
    </script>
</body>
</html>

